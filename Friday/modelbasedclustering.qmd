---
title: "Concepts in model-based clustering"
institute: "Summer School on model-based multivariate analysis for ecologists"
author: "Francis KC Hui"
format: 
  beamer:
    toc: false
    slide_level: 2
    pdf-engine: pdflatex
    include-in-header:
      - file: ../header.tex
    header-includes:
      - \usepackage{ulem}
      - \usepackage{booktabs}
      - \usepackage{longtable}
      - \tcbuselibrary{skins}
      - \usepackage{tikz}
      - \usetikzlibrary{positioning}
      - \tikzset{>=stealth}
      - \usetikzlibrary{arrows,shapes}
      - \tikzstyle{na} = [baseline=-.5ex]
      - \usepackage{multicol}
      - \usepackage{hyperref}
      - \usepackage{tikz}
      - \usetikzlibrary{calc, fit, positioning,arrows,shapes,tikzmark,spy,shadows.blur,matrix}
      - \newcommand{\highlight}[2]{\colorbox{#1!17}{$\vphantom{(^\top}#2$}}
      - \usepackage{longtable, tabularx, booktabs, caption, parskip}
      - \newcommand{\supertiny}{\fontsize{4}{5}\selectfont}
urlcolor: orange
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)

default_source_hook <- knit_hooks$get('source')
default_output_hook <- knit_hooks$get('output')

knit_hooks$set(
  source = function(x, options) {
    paste0(
      "\n::: {.codebox data-latex=\"\"}\n\n",
      default_source_hook(x, options),
      "\n\n:::\n\n")
  }
)

knit_hooks$set(
  output = function(x, options) {
    paste0(
      "\n::: {.codebox data-latex=\"\"}\n\n",
      default_output_hook(x, options),
      "\n\n:::\n\n")
  }
)

knitr::opts_chunk$set(echo = TRUE)
```

# Outline

-   Clustering sites and/or species
-   Clustering using covariates

## Questions so far?

\center

![](../questions.jpg){height="60%"}

# The models so far

Throughout the course of the summer school, many of the models we have studied so far can be written in the generic form:

\begin{equation}
\eta_{ij} = \beta_{0j} + \alpha_{i} + \delta_{ij},
\end{equation}

where:

-   $\beta_{0j}$ are species-specific intercepts (column standardization);
-   $\alpha_i$ are (optional) row effects (row standardization);
-   $\delta_{ij}$ is "stuff" e.g., effects of measured covariates, latent variables, traits and phylogeny etc...

# The models so far

Throughout the course of the summer school, many of the models we have studied so far can be written in the generic form:

\begin{equation}
\eta_{ij} = \beta_{0j} + \alpha_{i} + \delta_{ij},
\end{equation}

For the next little bit, we will assume $\alpha_i$ is always included i.e., both rows and columns are standardized.

By doing so, we can focus on the $\delta_{ij}$ part of the model i.e., what is left over after adjusting for heterogeneity in recorded species prevalence and site sampling effort.

# What to do about $\delta_{ij}$?

On Wednesday, we covered the idea of model-based ordination or some variation thereof, where $\delta_{ij} = \mathbf{u}^\top_i \mathbf{\gamma}_j$. Provided the number of latent variables is small, then the $\mathbf{u}_i$'s and/or $\mathbf{\gamma}_j$'s can be plotted in some way to give a low-dimensional representation of patterns in species composition/indicator species etc...

\pause

In this lecture, we will talk about another way to model the $\delta_{ij}$'s using ideas from clustering...

# What to do about $\delta_{ij}$?

Consider again the model

\begin{equation}
\eta_{ij} = \beta_{0j} + \alpha_{i} + \delta_{ij},
\end{equation}

and suppose now the $\delta_{ij}$'s are just directly estimated as fixed effects, alongside the $\beta_{0j}$'s and $\alpha_{i}$. We will refer this as the **saturated** model, since:

-   it estimates a unique "interaction" for every combination of sites and species;
-   the number of parameters is basically the same as the number of observations.


# What to do about $\delta_{ij}$?

```{r, echo = FALSE, out.width="80%", fig.align = "centre"}
library(tidyverse)
library(colorspace)

# Dummy data
set.seed(062025)

x <- paste("spp", LETTERS[1:20])
y <- paste ("site", seq(1,40))
data <- expand.grid(X = x, Y = y)
data$Z <- rnorm(400, 0, 0.5)
data <- data %>% 
    mutate(Y = fct_inorder(Y) %>% fct_rev(),
           X = fct_inorder(X))
 
# Heatmap 
ggplot(data, aes(X, Y, fill= Z)) + 
    geom_tile(show.legend = FALSE) + 
    labs(x = "Species", y = "Site") + 
    scale_fill_continuous_diverging(palette = "Blue-Yellow 2") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```


# Simplifying the $\delta_{ij}$'s

The above may be overly complex for many multivariate abundance datasets however, as in practice there may be **row patterns**

```{r, echo = FALSE, out.width="65%", fig.align = "centre"}
library(tidyverse)
library(colorspace)

# Dummy data
set.seed(062025)

x <- paste("spp", LETTERS[1:20])
y <- paste ("site", seq(1,40))
data <- expand.grid(X = x, Y = y)
data <- data %>% 
    mutate(Y = fct_inorder(Y) %>% fct_rev(),
           X = fct_inorder(X))
row_indices <- sample(1:5, length(y), replace = TRUE)
z_patterns <- matrix(rnorm(5*length(x)), nrow = 5)
data$Z <- z_patterns[row_indices,] %>% t %>% as.vector
 
# Heatmap 
ggplot(data, aes(X, Y, fill= Z)) + 
    geom_tile(show.legend = FALSE) + 
    labs(x = "Species", y = "Site") + 
    scale_fill_continuous_diverging(palette = "Blue-Yellow 2") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```


# Simplifying the $\delta_{ij}$'s

The above may be overly complex for many multivariate abundance datasets however, as in practice there may be **column patterns**

```{r, echo = FALSE, out.width="65%", fig.align = "centre"}
library(tidyverse)
library(colorspace)


# Dummy data
set.seed(062025)

x <- paste("spp", LETTERS[1:20])
y <- paste ("site", seq(1,40))
data <- expand.grid(X = x, Y = y)
data <- data %>% 
    mutate(Y = fct_inorder(Y) %>% fct_rev(),
           X = fct_inorder(X))
col_indices <- sample(1:3, length(x), replace = TRUE)
z_patterns <- matrix(rnorm(3*length(y)), ncol = 3)
data$Z <- z_patterns[,col_indices] %>% t %>% as.vector
 
# Heatmap 
ggplot(data, aes(X, Y, fill= Z)) + 
    geom_tile(show.legend = FALSE) + 
    labs(x = "Species", y = "Site") + 
    scale_fill_continuous_diverging(palette = "Blue-Yellow 2") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```


# Simplifying the $\delta_{ij}$'s

The above may be overly complex for many multivariate abundance datasets however, as in practice there may be **row & column patterns**

```{r, echo = FALSE, out.width="65%", fig.align = "centre"}
library(tidyverse)
library(colorspace)


# Dummy data
set.seed(062025)

x <- paste("spp", LETTERS[1:20])
y <- paste ("site", seq(1,40))
data <- expand.grid(X = x, Y = y)
data <- data %>% 
    mutate(Y = fct_inorder(Y) %>% fct_rev(),
           X = fct_inorder(X))
col_indices <- sample(1:3, length(x), replace = TRUE)
row_indices <- sample(1:5, length(y), replace = TRUE)
z_patterns <- matrix(rnorm(15), nrow = row_indices %>% unique %>% length)
z_patterns <- z_patterns[row_indices, col_indices]
data$Z <- z_patterns %>% t %>% as.vector
 
# Heatmap 
ggplot(data, aes(X, Y, fill= Z)) + 
    geom_tile(show.legend = FALSE) + 
    labs(x = "Species", y = "Site") + 
    scale_fill_continuous_diverging(palette = "Blue-Yellow 2") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

# Clustering the $\delta_{ij}$'s

The above motivates a way of simplifying the saturated model, namely by clustering the interaction terms $\delta_{ij}$'s based on the row and/or column indices:

- **Row/site clustering**: $\delta_{rj}$ where $r = 1, \ldots,R < n$;
- **Column/species clustering**: $\delta_{ic}$ where $c = 1, \ldots, C < m$;
- **Biclustering**: $\delta_{rc}$.


# Row pattern detection model
Assume the patterns of site relative abundance can be in clustered into one of $R < n$ groups:

\begin{equation}
\eta_{ij} = \beta_{0j} + \alpha_{i} + \delta_{rj}.
\end{equation}

\textcolor{blue}{Intuition}: The assemblage is comprised of only a small number of ``species profiles". Two sites $i$ and $i'$ in the same species profile have the same relative abundance and only differ in their $\alpha_{i}$'s e.g., site total abundance, sampling effort, and so on.


# Column pattern detection model
Assume the species can be in clustered into one of $C < m$ groups:

\begin{equation}
\eta_{ij} = \beta_{0j} + \alpha_{i} + \delta_{ic}.
\end{equation}

\textcolor{blue}{Intuition}: The species in the assemblage can be classified into a small number of "archetypes" (or guilds?). Two species $j$ and $j'$ in the same guild have the same distribution across sites, and only differ in their $\beta_{0j}$'s e.g., overall prevalence. 


# Biclustering pattern detection model
Assume the species can be in clustered into one of $C < m$ groups:

\begin{equation}
\eta_{ij} = \beta_{0j} + \alpha_{i} + \delta_{ic}.
\end{equation}

\textcolor{blue}{Intuition}: Combine the ideas of species profiles and guilds.


# Pattern detection model


<!-- ## Phylogenetic signal -->

<!-- \vspace*{-0.25\baselineskip} -->

<!--   - 1: Fully phylogenetically structured responses -->

<!--   - 0: Normal ("iid") random effects -->

<!-- When it is 0, it does not mean there is nothing going on. -->

<!-- Absence of phylogenetic signal: -->

<!-- \vspace*{-0.25\baselineskip} -->

<!--   - Scale mismatch -->

<!--   - Evolution moves very fast -->

<!--   - Too little information -->

<!--   - Traits are phylogenetically structured -->

<!--   - There are other (flexible) terms in the model -->

<!--   - Model misspecification -->

<!-- \vspace*{-0.25\baselineskip} -->

<!-- Presence of phylogenetic signal: -->

<!-- - Related species have similar "traits" (environmental response) -->

<!-- - Occupy similar environments -->

<!-- ## Model limitation -->

<!-- This phylogenetic model assumes traits evolve following the Brownian motion model of evolution. This can only generate positive associations. \newline -->

<!-- \vspace*{-\baselineskip} -->

<!-- But, competitive exclusion tells us that species evolve to differentiate resource. -->

<!-- - Similar species can (stably) co-occur if they utilize a different resource -->

<!-- - Similar species that utilize the same resource should not (stably) co-occur -->

<!-- The latter results in negative correlations, but no corresponding model for trait evolution has been developed -->

<!-- \footnotesize -->

<!-- * unless species do not stably co-occur and/or evolution is still ongoing -->

<!-- # Example 2 -->

<!-- ## Example with fungi data (Abrego 2021) -->

<!-- \centering -->

<!-- ![](Abrego.png) -->

<!-- ## Example with fungi data  -->

<!-- \footnotesize -->

<!-- ```{r, echo = FALSE} -->

<!-- Y = read.csv("../data/fungiY.csv",)[,-1] -->

<!-- X = read.csv("../data/fungiX.csv")[,-1] -->

<!-- tree = ape::read.tree("../data/fungiTree.txt") -->

<!-- ``` -->

<!-- - 215 species (after cleaning) -->

<!-- - 1666 sites -->

<!-- - 19 covariates of various kinds -->

<!-- ![[image from Yang et al. 2021](https://nsojournals.onlinelibrary.wiley.com/doi/10.1111/oik.08388)](fungi.png){width=90%} -->

<!-- ## Example with fungi data -->

<!-- ```{r tree, fig.align="center", fig.height = 6, echo = FALSE} -->

<!-- plot(tree, show.tip.label = FALSE) -->

<!-- ``` -->

<!-- ## Example with fungi data -->

<!-- Phylogenetic models in \texttt{gllvm} use a **nearest neighbour approximation** -->

<!-- - We need to set the number of tips to consider on the tree -->

<!-- - [The ordering of species matters!](https://jenniniku.github.io/gllvm/articles/vignette7.html) -->

<!-- ```{r} -->

<!-- covMat <- ape::vcv(tree) -->

<!-- e <- eigen(covMat) -->

<!-- distMat <- ape::cophenetic.phylo(tree) -->

<!-- ord <- gllvm:::findOrder(covMat = covMat, distMat = distMat, nn = 15, order = order(e$vectors[,1]))$order -->

<!-- species <- colnames(covMat)[ord] -->

<!-- Y <- Y[, species] -->

<!-- covMat <- covMat[species, species] -->

<!-- distMat <- distMat[species, species] -->

<!-- ``` -->

<!-- ## Ordering species -->

<!-- ![See vignette 7](specord-1.png){height=70%} -->

<!-- ## Example with fungi data -->

